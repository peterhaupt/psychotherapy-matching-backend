# Communication Service

> **Note**: For complete API documentation, see `API_REFERENCE.md`

## Summary
Simplified infrastructure service handling all emails and phone calls for both therapists and patients. Focuses solely on communication delivery with markdown support and legal compliance features.

## Current Status ✅ SIMPLIFIED & OPERATIONAL
- **Dual Recipients**: All APIs support both therapist_id AND patient_id
- **Markdown Support**: Email creation with markdown-to-HTML conversion
- **Legal Footer**: Automatic footer injection for compliance
- **No Business Logic**: Removed frequency limiting and complex scheduling
- **Template-Free**: All email content generated by requesting services

## Core Models

### Email Model
```python
# Supports EITHER therapist OR patient (not both)
therapist_id = Column(Integer, nullable=True)
patient_id = Column(Integer, nullable=True)

# German field names throughout
betreff, empfaenger_email, empfaenger_name
status = EmailStatus (German enum: Entwurf, In_Warteschlange, Gesendet, etc.)

# Removed: nachverfolgung_erforderlich, nachverfolgung_notizen
```

### PhoneCall Model  
```python
# Same dual recipient pattern
therapist_id = Column(Integer, nullable=True)
patient_id = Column(Integer, nullable=True)

# German field names
geplantes_datum, geplante_zeit, dauer_minuten
status = PhoneCallStatus (German enum: geplant, abgeschlossen, etc.)

# Removed: wiederholen_nach
```

## Key Features

### Markdown Email Support
```bash
POST /api/emails
{
  "patient_id": 123,
  "betreff": "Willkommen",
  "body_markdown": "# Hello\n\n**Bold text** and *italics*\n\n- Lists\n- Tables\n- Links",
  "add_legal_footer": true  # Default: true
}
```

### Automatic Features
- **HTML Conversion**: Markdown → styled HTML
- **Plain Text**: Auto-generated from markdown
- **Legal Footer**: GDPR-compliant footer (when enabled)
- **Last Contact Update**: Patient's `letzter_kontakt` auto-updated

### Simplified Phone Scheduling
- **Therapists**: Basic slot finding (10:00 or 14:00 tomorrow)
- **Patients**: Manual scheduling or defaults
- **No Complex Logic**: Advanced scheduling moved to requesting services

## API Highlights

### Creating Communications
```bash
# Must specify EXACTLY ONE recipient type

# Email to therapist (markdown)
POST /api/emails
{
  "therapist_id": 123,    # XOR with patient_id
  "body_markdown": "..."   # OR inhalt_html
}

# Email to patient (HTML)
POST /api/emails  
{
  "patient_id": 456,      # XOR with therapist_id
  "inhalt_html": "...",
  "add_legal_footer": false
}
```

### Filtering Support
```bash
# By recipient type
GET /api/emails?recipient_type=patient
GET /api/phone-calls?recipient_type=therapist

# By specific recipient
GET /api/emails?patient_id=123
GET /api/phone-calls?therapist_id=456
```

## Integration Points

### With Matching Service
- Matching generates email content as markdown
- Calls Communication API to send
- No template references needed

### With Patient Service  
- Uses `patient_service/utils/communication.py` helpers
- Automatic last contact tracking
- Pre-built email functions (welcome, updates, matches)

## Configuration
Via `shared.config`:
- SMTP settings (host, port, TLS)
- Default sender (info@curavani.de)
- Company branding (Curavani Therapievermittlung GmbH)
- Legal footer control (`EMAIL_ADD_LEGAL_FOOTER`)

## Events Published
- `communication.email_created`
- `communication.email_sent`
- `communication.call_scheduled`
- `communication.call_completed`

## Best Practices
1. **One Recipient Rule**: Always specify either therapist_id OR patient_id
2. **Use Markdown**: Cleaner than HTML, automatic styling
3. **Legal Compliance**: Keep footer enabled for production
4. **Let Services Handle Logic**: Communication service just sends

## Migration Notes
- ✅ Database fields removed (nachverfolgung_*, wiederholen_nach)
- ✅ Business logic removed (frequency checks, complex scheduling)
- ✅ Templates removed (content generation in requesting services)
- ✅ Markdown processor added with legal footer support
- ✅ Company references updated to Curavani