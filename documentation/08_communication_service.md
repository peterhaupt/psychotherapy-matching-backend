# Communication Service

> **Note**: For complete API documentation, see `API_REFERENCE.md`

## Summary
Streamlined infrastructure service handling all emails and phone calls for both therapists and patients. Focuses on communication delivery with markdown support, legal compliance features, and dual recipient architecture.

## Current Status âœ… SIMPLIFIED & OPERATIONAL
- **Dual Recipients**: All APIs support both `therapist_id` AND `patient_id`
- **Markdown Support**: Email creation with markdown-to-HTML conversion
- **Legal Footer**: Automatic footer injection for GDPR compliance
- **No Business Logic**: Removed frequency limiting and complex scheduling
- **Template-Free**: All email content generated by requesting services

## Core Architecture

### Dual Recipient Design
Both email and phone call models support either therapist or patient recipients:
```python
# Supports EITHER therapist OR patient (not both)
therapist_id = Column(Integer, nullable=True)
patient_id = Column(Integer, nullable=True)
# Check constraint: exactly one must be set
```

### Email Model Features
- **German field names**: `betreff`, `empfaenger_email`, `empfaenger_name`
- **Status management**: German enum (`Entwurf`, `In_Warteschlange`, `Gesendet`, etc.)
- **Response tracking**: `antwort_erhalten`, `antwortdatum`, `antwortinhalt`
- **Retry handling**: `wiederholungsanzahl`, `fehlermeldung`

### Phone Call Model Features  
- **German field names**: `geplantes_datum`, `geplante_zeit`, `dauer_minuten`
- **Status tracking**: German enum (`geplant`, `abgeschlossen`, `fehlgeschlagen`, etc.)
- **Outcome recording**: `ergebnis`, `notizen` for call documentation
- **Flexible scheduling**: Manual or automatic slot finding

## Key Features

### Markdown Email Support
Advanced email composition capabilities:
- **Markdown processing**: Automatic conversion to styled HTML
- **Link detection**: URLs automatically converted to clickable links
- **Plain text generation**: Auto-generated from markdown content
- **Styling**: Professional email templates with consistent branding

### Email Status Management
Comprehensive status flow control:
1. **Draft Flow**: `status: "Entwurf"` - Saved but not sent
2. **Send Flow**: `status: "In_Warteschlange"` - Queued for immediate sending
3. **Processing**: Automatic progression through sending states
4. **Completion**: Final status of `Gesendet` or `Fehlgeschlagen`

### Legal Compliance Features
- **GDPR Footer**: Automatic legal footer injection (configurable)
- **Data Protection**: Proper handling of personal communication data
- **Audit Trail**: Complete tracking of all communication attempts
- **Consent Management**: Proper handling of communication preferences

### Simplified Phone Scheduling
- **Basic slot finding**: Simple availability checking (10:00 or 14:00 slots)
- **Manual scheduling**: Full control over call timing
- **Auto-scheduling**: For therapists based on `telefonische_erreichbarkeit`
- **No complex logic**: Advanced scheduling moved to requesting services

## Service Integration

### With Matching Service
Primary communication driver for the anfrage system:
- **Anfrage emails**: Automatically generated inquiry emails to therapists
- **Professional formatting**: Patient lists with key demographics
- **Reference numbers**: Trackable inquiry identifiers (A{anfrage_id})
- **Response handling**: Email response monitoring and processing

### With Patient Service  
Comprehensive patient communication support:
- **Helper functions**: Pre-built utilities in `patient_service/utils/communication.py`
- **Automatic tracking**: Updates `letzter_kontakt` field automatically
- **Journey communications**: Welcome emails, status updates, match notifications
- **Markdown support**: Rich formatting for patient communications

### With Therapist Service
Professional therapist communication:
- **Helper functions**: Utilities in `therapist_service/utils/communication.py`
- **Contact date tracking**: Automatic updates to contact history fields
- **Professional templates**: Appropriate tone and formatting for professional communications
- **Availability integration**: Respects therapist phone availability schedules

## Configuration Management

All settings managed via `shared.config`:
- **SMTP settings**: Host, port, authentication, TLS configuration
- **Default sender**: Company email and branding (`info@curavani.de`)
- **Company information**: Curavani Therapievermittlung GmbH branding
- **Legal footer control**: `EMAIL_ADD_LEGAL_FOOTER` configuration flag
- **Feature toggles**: Enable/disable email sending and phone scheduling

## Events and Integration

### Published Events
- `communication.email_created` - Email composition completed
- `communication.email_sent` - Email successfully delivered
- `communication.call_scheduled` - Phone call appointment created
- `communication.call_completed` - Phone call finished with outcome

### Consumer Framework
- **Email queue processing**: Background worker for queued emails
- **Status updates**: Real-time communication status propagation
- **Cross-service notifications**: Integration with patient/therapist services

## Technical Features

### Robust Email Delivery
- **Queue processing**: Background workers handle email delivery
- **Retry logic**: Automatic retry for failed deliveries
- **Status tracking**: Real-time delivery status monitoring
- **Error handling**: Comprehensive error logging and recovery

### Markdown Processing
- **Link detection**: Automatic URL to link conversion
- **HTML generation**: Professional styling and formatting
- **Plain text extraction**: Clean text versions for accessibility
- **Template integration**: Consistent styling across all emails

### Database Design
- **Cross-service references**: Simple integer foreign keys to other services
- **Status consistency**: German enum values throughout
- **Audit capabilities**: Complete communication history tracking
- **Performance optimization**: Indexed fields for common queries

## Best Practices Implementation

### Single Responsibility
- **Communication only**: No business logic for frequency or scheduling rules
- **Content agnostic**: Accepts content from requesting services
- **Transport layer**: Focuses on reliable message delivery
- **Status reporting**: Provides comprehensive delivery feedback

### Error Handling
- **Graceful degradation**: Continues operation during external service outages
- **Comprehensive logging**: Detailed error tracking and reporting
- **Recovery mechanisms**: Automatic retry and queue processing
- **Status consistency**: Reliable status updates across all operations

### Security and Compliance
- **Data protection**: Secure handling of personal communication data
- **Access control**: Proper validation of recipient information
- **Legal compliance**: Automatic footer inclusion and data retention policies
- **Audit trail**: Complete logging for compliance reporting

This streamlined architecture provides reliable communication infrastructure while maintaining flexibility for the specific needs of the therapy matching platform.